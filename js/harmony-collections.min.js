/* (The MIT License)
 *
 * Copyright (c) 2012 Brandon Benvie <http://bbenvie.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
 * associated documentation files (the 'Software'), to deal in the Software without restriction,
 * including without limitation the rights to use, copy, modify, merge, publish, distribute,
 * sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included with all copies or
 * substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING
 * BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY  CLAIM,
 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

// Original WeakMap implementation by Gozala @ https://gist.github.com/1269991
// Updated and bugfixed by Raynos @ https://gist.github.com/1638059
// Expanded by Benvie @ https://github.com/Benvie/harmony-collections

void function(e,t,n,r,i,s,o,u,a,f,l,c,h){function C(){}var p=o.getOwnPropertyNames,d=typeof p===n&&!(r in p);var v=a.bind?a.bind.bind(a.call):function(e){return function(t){return function(){return e.apply(t,arguments)}}}(a.call);var m=v(a[i]),g=v({}[i]),y=v(0..toString),b=v(a.call),w=v(a.apply),E=v({}.hasOwnProperty),S=v([].push),x=v([].splice);var T=function(e){if(typeof e!==n)return"";else if("name"in e)return e.name;return m(e).match(/^\n?function\s?(\w*)?_?\(/)[1]};var N=d?o.create:function(e,t){var n=function(){};n[r]=o(e);var i=new n;if(t)for(var s in t)L(i,s,t[k]);return i};if(d||typeof document==="undefined"){void function(e){function t(t){return e(t)}C.prototype=e(null);C.inherit=t}(o.create)}else{void function(e){function i(t){e.prototype=t;t=new e;e.prototype=null;return t}var t=document.createElement("iframe");t.style.display="none";document.body.appendChild(t);t.src="javascript:";C.prototype=t.contentWindow.Object.prototype;document.body.removeChild(t);t=null;var n=["constructor","hasOwnProperty","propertyIsEnumerable","isProtoypeOf","toLocaleString","toString","valueOf"];for(var r=0;r<n.length;r++)delete C.prototype[n[r]];C.inherit=i}(function(){})}var L=d?o.defineProperty:function(e,t,n){e[t]=n.value;return e};var A=function(e,t,r){if(typeof t===n){r=t;t=T(r).replace(/_$/,"")}return L(e,t,{configurable:true,writable:true,value:r})};var O=d?function(e){return function(t){return e(t)||t instanceof s}}(s.isArray):function(e){return e instanceof s||g(e)==="[object Array]"};var M="WeakMap"in f;var _=M?function(){function s(r){var s=new e;this.get=function(e){return t(s,e)};this.set=function(e,t){n(s,e,t)};if(r){this.wrap=function(e,t){if(i(s,e))throw new TypeError("Object is already a "+r);n(s,e,t)};this.unwrap=function(e){var n=t(s,e);if(!n)throw new TypeError(r+" is not generic");return n}}}var e=f.WeakMap,t=v(e[r].get),n=v(e[r].set),i=v(e[r].has);return s}():function(){function c(e){var t=p(e);if(E(e,l))x(t,a(t,l),1);return t}function b(t){var n=f(),r=f(),i={value:h,writable:true};var s=function(t){var s=m(t);if(E(s,n))return s[n](i);var o=new C;L(o,r,i);L(s,n,{value:(new u("s","l",e))(i,o)});return o};this.get=function(e){return s(e)[r]};this.set=function(e,t){s(e)[r]=t};if(t){this.wrap=function(e,n){var i=s(e);if(i[r])throw new TypeError("Object is already a "+t);i[r]=n};this.unwrap=function(e){var n=s(e)[r];if(!n)throw new TypeError(t+" is not generic");return n}}}var e="return function(k){if(k===s)return l}",t=Math.random,n=new C,s=v("".slice),a=v([].indexOf);var f=function(){var e=s(y(t(),36),2);return e in n?f():n[e]=e};var l=f();if(d){var m=function(e){if(!E(e,l))L(e,l,{value:new C});return e[l]};A(o,c)}else{var g=function(e){function t(){return e}return t[i]=t}(o[r][i]+"");var m=function(e){function n(){return t.call(this)}if(E(e,i)&&l in e[i])return e[i][l];if(!(i in e))throw new Error("Can't store values for "+e);var t=e[i];e[i]=n;n[i]=g;return n[l]={}}}return b}();var D=function(){function t(){return e[0]+T(this)+e[1]}var e=(""+o).split("Object");A(t,t);var n={__proto__:[]}instanceof s?function(e){e.__proto__=t}:function(e){A(e,t)};var i=function(e){function s(){return i}var t=e.shift(),i="[object "+T(t)+"]";e.push(s);n(t);for(var o=0;o<e.length;o++){n(e[o]);A(t[r],e[o])}return t};return function(e,t){if(e in l)return l[e];var n=new _(e);return l[e]=i(t(function(e,t){n.wrap(e,t)},function(e){return n.unwrap(e)}))}}();var P=function(e,r){if(e!==null&&typeof e===t&&typeof e.forEach===n){e.forEach(function(t,n){if(O(t)&&t.length===2)r(e[n][0],e[n][1]);else r(e[n],n)})}};var H=function(e,t,n){try{t[t.length]=("return "+e).replace("e_","\\u0065");return u.apply(0,t).apply(0,n)}catch(r){return e}};var B,j,F;B=M?l.WeakMap=f.WeakMap:D("WeakMap",function(e,i){function u(t){if(this===f||this==null||this===s)return new u(t);e(this,new _);var n=this;t&&P(t,function(e,t){b(l,n,e,t)})}function a(e){o(e);var t=i(this).get(e);return t===c?h:t}function l(e,t){o(e);i(this).set(e,t===h?c:t)}function p(e){o(e);return i(this).get(e)!==h}function d(e){o(e);var t=i(this);if(t.get(e)===h)return false;t.set(e,h);return true}var s=u[r];var o=function(e){if(e==null||typeof e!==t&&typeof e!==n)throw new TypeError("Invalid WeakMap key")};d=H(d,["validate","unwrap"],[o,i]);return[u,a,l,p,d]});j=D("HashMap",function(t,n){function d(e){if(this===f||this==null||this===i)return new d(e);t(this,{size:0,0:new C,1:new C,2:new C});var n=this;e&&P(e,function(e,t){b(m,n,e,t)})}function v(e){return n(this)[p(e)][c(e)]}function m(e,t){var r=n(this),i=r[p(e)];e=c(e);e in i||r.size++;i[e]=t}function g(e){return c(e)in n(this)[p(e)]}function y(e){var t=n(this),r=t[p(e)];e=c(e);if(e in r){delete r[e];t.size--;return true}return false}function w(){return n(this).size}function E(e,t){var r=n(this);t=t==null?f:t;for(var i=0;i<3;i++)for(var s in r[i])b(e,t,r[i][s],h(i,s),this)}var i=d[r],s=0,o=1,u=2,a={"true":true,"false":false,"null":null,0:-0};var l=Math.random().toString(36).slice(2);var c=function(e){return e==="__proto__"?l:e};var h=function(e,t){switch(e){case s:return t===l?"__proto__":t;case o:return+t;case u:return a[t]}};var p=function(t){if(t==null)return u;switch(typeof t){case"boolean":return u;case e:return s;case"number":return t===0&&Infinity/t===-Infinity?u:o;default:throw new TypeError("Invalid HashMap key")}};y=H(y,["validate","unwrap","coerce"],[p,n,c]);return[d,v,m,g,y,w,E]});if("Map"in f&&"forEach"in f.Map.prototype){F=l.Map=f.Map}else{F=D("Map",function(e,i){function y(t){if(this===f||this==null||this===o)return new y(t);var n=g();n.keys=[];n.values=[];e(this,n);var r=this;t&&P(t,function(e,t){b(E,r,e,t)})}function w(e){var t=i(this),n=m(e);return t.values[l[n](t[n],e)]}function E(e,t){var n=i(this),r=m(e),s=l[r](n[r],e);if(s===h){c[r](n[r],e,n.keys.length);S(n.keys,e);S(n.values,t)}else{n.keys[s]=e;n.values[s]=t}}function T(e){var t=m(e);return p[t](i(this)[t],e)}function N(e){var t=i(this),n=m(e),r=l[n](t[n],e);if(r===h)return false;d[n](t[n],e);x(t.keys,r,1);x(t.values,r,1);return true}function C(){return i(this).keys.length}function k(e,t){var n=i(this),r=n.keys,s=n.values;t=t==null?f:t;for(var o=0,u=r.length;o<u;o++)b(e,t,s[o],r[o],this)}var s=f.Map,o=y[r],u=B[r],a=(s||j)[r],l=[v(a.get),v(u.get)],c=[v(a.set),v(u.set)],p=[v(a.has),v(u.has)],d=[v(a["delete"]),v(u["delete"])];var m=s?function(){return 0}:function(e){return+(typeof e===t?e!==null:typeof e===n)};var g=s?function(){return{0:new s}}:function(){return{0:new j,1:new B}};N=H(N,["type","unwrap","call","splice"],[m,i,b,x]);return[y,w,E,T,N,C,k]})}D("Set",function(e,t){function h(t){if(this===f||this==null||this===n)return new h(t);e(this,new F);var r=this;t&&P(t,function(e,t){b(p,r,e)})}function p(e){a(t(this),e,e)}function d(e){return l(t(this),e)}function m(e){return c(t(this),e)}function g(){return s(t(this))}function y(e,n){var r=0,i=this;o(t(this),function(t){b(e,this,t,r++,i)},n)}var n=h[r],i=F[r],s=v(i.size),o=v(i.forEach),u=v(i.get),a=v(i.set),l=v(i.has),c=v(i["delete"]);m=H(m,["mdelete","unwrap"],[c,t]);return[h,p,d,m,g,y]})}("string","object","function","prototype","toString",Array,Object,Function,Function.prototype,(0,eval)("this"),typeof exports==="undefined"?this:exports,{})